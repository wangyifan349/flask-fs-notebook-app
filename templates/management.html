{% extends 'base.html' %}
{% block title %}ç®¡ç†ç¬”è®°{% endblock %}
{% block content %}
<h1>ç®¡ç†ç¬”è®°</h1>

<div class="input-group mb-3">
  <input id="search-input" type="text" class="form-control" placeholder="æœç´¢â€¦">
  <button id="btn-search" class="btn btn-outline-secondary">ğŸ”</button>
</div>

<table class="table table-hover">
  <thead><tr><th>æ ‡é¢˜</th><th>æ“ä½œ</th></tr></thead>
  <tbody id="note-list">
    {% for n in notes %}
    <tr data-title="{{n.title}}">
      <td class="title">{{n.title}}</td>
      <td>
        <a href="{{ url_for('view', title=n.title) }}" target="_blank"
           class="btn btn-sm btn-success">æŸ¥çœ‹</a>
        <button class="btn btn-sm btn-warning btn-rename">é‡å‘½å</button>
        <button class="btn btn-sm btn-danger btn-delete">åˆ é™¤</button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<button id="btn-new" class="btn btn-primary">æ–°å»ºç¬”è®°</button>

<!-- Modal -->
<div class="modal fade" id="mdl" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" id="mdl-form">
      <div class="modal-header">
        <h5 class="modal-title" id="mdl-title">æ ‡é¢˜</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input id="mdl-input" class="form-control" placeholder="è¾“å…¥ç¬”è®°å">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary"
                data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button id="mdl-ok" class="btn btn-primary">ç¡®å®š</button>
      </div>
    </form>
  </div>
</div>

<hr>
<h2>æ–‡ä»¶ç®¡ç†</h2>
<form id="frm-upload" enctype="multipart/form-data">
  <input type="file" name="file">
  <button class="btn btn-sm btn-info">ä¸Šä¼ </button>
</form>
<ul id="file-list" class="list-group mt-2"></ul>
{% endblock %}

{% block scripts %}
<script>
let modal = new bootstrap.Modal('#mdl'), act, oldName;
function ajax(url, data, cb){
  fetch(url, {method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(data)})
  .then(r=>r.json().then(j=>r.ok?cb(j):Promise.reject(j.error)))
  .catch(e=>alert(e));
}

// æ–°å»º
document.getElementById('btn-new').onclick = ()=>{
  act='new'; oldName=''; 
  document.getElementById('mdl-title').innerText='æ–°å»ºç¬”è®°';
  document.getElementById('mdl-input').value=''; modal.show();
};
// é‡å‘½å
document.querySelectorAll('.btn-rename').forEach(btn=>{
  btn.onclick = e=>{
    act='rename';
    let tr=e.target.closest('tr');
    oldName=tr.dataset.title;
    document.getElementById('mdl-title').innerText='é‡å‘½å';
    document.getElementById('mdl-input').value=oldName;
    modal.show();
  };
});
// åˆ é™¤
document.querySelectorAll('.btn-delete').forEach(btn=>{
  btn.onclick = e=>{
    let t=e.target.closest('tr').dataset.title;
    if(confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) {
      ajax('/note/delete',{title:t},()=>location.reload());
    }
  };
});
// Modal ç¡®å®š
document.getElementById('mdl-ok').onclick = e=>{
  e.preventDefault();
  let v=document.getElementById('mdl-input').value.trim();
  if(act=='new') ajax('/note/new',{title:v},()=>location.reload());
  else ajax('/note/rename',{old:oldName,new:v},()=>location.reload());
};

// æœç´¢
document.getElementById('btn-search').onclick = ()=>{
  let q=document.getElementById('search-input').value.trim();
  if(!q) return location.reload();
  fetch('/search?q='+encodeURIComponent(q))
    .then(r=>r.json()).then(list=>{
      let tb=document.getElementById('note-list');
      tb.innerHTML='';
      list.forEach(n=>{
        let tr=document.createElement('tr');
        tr.dataset.title=n.title;
        tr.innerHTML=`<td class="title">${n.title}</td>
          <td>
            <a class="btn btn-sm btn-success" target="_blank"
               href="/view/${n.title}">æŸ¥çœ‹</a>
            <button class="btn btn-sm btn-warning btn-rename">
               é‡å‘½å</button>
            <button class="btn btn-sm btn-danger btn-delete">
               åˆ é™¤</button>
          </td>`;
        tb.appendChild(tr);
      });
      // ç®€å•é‡ç»‘ï¼Œæˆ–ç›´æ¥ reload æ›´æ–¹ä¾¿
      location.reload();
    });
};

// ä¸Šä¼ æ–‡ä»¶
document.getElementById('frm-upload').onsubmit = e=>{
  e.preventDefault();
  let fd=new FormData(e.target);
  fetch('/upload',{method:'POST', body:fd})
    .then(r=>r.json().then(j=>r.ok?listFiles():alert(j.error)))
    .catch(e=>alert(e));
};
// åˆ—å‡ºæ–‡ä»¶
function listFiles(){
  fetch('/files').then(r=>r.json()).then(arr=>{
    let ul=document.getElementById('file-list');
    ul.innerHTML='';
    arr.forEach(f=>{
      let li=document.createElement('li');
      li.className='list-group-item';
      let ext=f.name.split('.').pop().toLowerCase();
      let link=`<a href="${f.url}" target="_blank">${f.name}</a>`;
      if(['mp4','mp3','ogg'].includes(ext)){
        link+=`<br><${ext} controls src="${f.url}"
          style="max-width:100%;margin-top:5px;"></${ext}>`;
      }
      li.innerHTML=link;
      ul.appendChild(li);
    });
  });
}
listFiles();
</script>
{% endblock %}
