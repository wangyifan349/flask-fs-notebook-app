import os, shutil
from flask import (
    Flask, request, jsonify, redirect, url_for,
    send_from_directory, abort, render_template_string
)
from werkzeug.utils import secure_filename

app = Flask(__name__)
app.secret_key = 'è¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„éšæœºå­—ç¬¦ä¸²'

# é…ç½®ç›®å½•ä¸å…è®¸çš„ä¸Šä¼ åç¼€
NOTE_DIR    = 'notes'
UPLOAD_DIR  = 'uploads'
ALLOWED_EXT = {'png','jpg','jpeg','gif','mp4','mp3','ogg'}

# å¯åŠ¨å‰ç¡®ä¿ç›®å½•å­˜åœ¨
for d in (NOTE_DIR, UPLOAD_DIR):
    os.makedirs(d, exist_ok=True)

# --- æ¨¡æ¿ï¼šbase.html ---
BASE_HTML = '''
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}{% endblock %} - äº‘ç«¯ç¬”è®°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
        rel="stylesheet">
  {% block head %}{% endblock %}
</head>
<body class="p-4 bg-light">
  <div class="container bg-white p-4 shadow-sm rounded">
    {% with msgs = get_flashed_messages(with_categories=true) %}
      {% if msgs %}
        {% for c,m in msgs %}
          <div class="alert alert-{{ c }} alert-dismissible fade show">
            {{ m }}
            <button class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  {% block scripts %}{% endblock %}
</body>
</html>
'''

# --- æ¨¡æ¿ï¼šmanagement.html ---
MGMT_HTML = '''
{% extends 'base' %}
{% block title %}ç®¡ç†ç¬”è®°{% endblock %}
{% block content %}
<h1 class="mb-4">ç®¡ç†ç¬”è®°</h1>

<div class="input-group mb-3">
  <input id="search-input" type="text" class="form-control" placeholder="æœç´¢æ ‡é¢˜æˆ–å†…å®¹â€¦">
  <button id="btn-search" class="btn btn-outline-primary">ğŸ” æœç´¢</button>
  <button id="btn-clear" class="btn btn-outline-secondary">æ¸…é™¤</button>
</div>

<table class="table table-hover">
  <thead><tr><th>æ ‡é¢˜</th><th>æ“ä½œ</th></tr></thead>
  <tbody id="note-list">
    {% for n in notes %}
    <tr data-title="{{n.title}}">
      <td class="title">{{n.title}}</td>
      <td>
        <a href="{{ url_for('view', title=n.title) }}" target="_blank"
           class="btn btn-sm btn-success">æŸ¥çœ‹</a>
        <button class="btn btn-sm btn-warning btn-rename">é‡å‘½å</button>
        <button class="btn btn-sm btn-danger btn-delete">åˆ é™¤</button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<button id="btn-new" class="btn btn-primary mb-5">ï¼‹ æ–°å»ºç¬”è®°</button>

<hr>

<h2 class="mt-4">æ–‡ä»¶ç®¡ç†</h2>
<form id="frm-upload" class="input-group mb-3" enctype="multipart/form-data">
  <input type="file" name="file" class="form-control">
  <button class="btn btn-info">ä¸Šä¼ </button>
</form>
<ul id="file-list" class="list-group"></ul>
{% endblock %}

{% block scripts %}
<script>
// å…¨å±€ AJAX POST ç®€æ˜“å°è£…
function ajax(url, data, cb){
  fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(data)
  })
  .then(r => r.json().then(j=> r.ok?cb(j):Promise.reject(j.error)))
  .catch(e => alert(e));
}

// Modal æ§ä»¶
let modal = new bootstrap.Modal('#mdl'), act, oldName;

// æ–°å»º
document.getElementById('btn-new').onclick = ()=>{
  act='new'; oldName='';
  document.getElementById('mdl-title').innerText='æ–°å»ºç¬”è®°';
  document.getElementById('mdl-input').value='';
  modal.show();
};

// é‡å‘½å
document.querySelectorAll('.btn-rename').forEach(btn=>{
  btn.onclick = e=>{
    act='rename';
    let tr = e.target.closest('tr');
    oldName = tr.dataset.title;
    document.getElementById('mdl-title').innerText='é‡å‘½å';
    document.getElementById('mdl-input').value = oldName;
    modal.show();
  };
});

// åˆ é™¤
document.querySelectorAll('.btn-delete').forEach(btn=>{
  btn.onclick = e=>{
    let t = e.target.closest('tr').dataset.title;
    if(confirm('ç¡®å®šåˆ é™¤ç¬”è®°ï¼Ÿ')) {
      ajax('/note/delete',{title:t},()=>location.reload());
    }
  };
});

// Modal ç¡®å®š
document.getElementById('mdl-ok').onclick = e=>{
  e.preventDefault();
  let v = document.getElementById('mdl-input').value.trim();
  if(!v){alert('åç§°ä¸èƒ½ä¸ºç©º');return;}
  if(act=='new')   ajax('/note/new',{title:v},()=>location.reload());
  else             ajax('/note/rename',{old:oldName,new:v},()=>location.reload());
};

// æœç´¢
document.getElementById('btn-search').onclick = ()=>{
  let q = document.getElementById('search-input').value.trim();
  if(!q){return;}
  fetch('/search?q='+encodeURIComponent(q))
    .then(r=>r.json())
    .then(list=>{
      let tb = document.getElementById('note-list');
      tb.innerHTML = '';
      list.forEach(n=>{
        let tr = document.createElement('tr');
        tr.dataset.title = n.title;
        tr.innerHTML = `
          <td>${n.title}</td>
          <td>
            <a class="btn btn-sm btn-success" target="_blank"
               href="/view/${n.title}">æŸ¥çœ‹</a>
            <button class="btn btn-sm btn-warning btn-rename">é‡å‘½å</button>
            <button class="btn btn-sm btn-danger btn-delete">åˆ é™¤</button>
          </td>`;
        tb.appendChild(tr);
      });
      // é‡æ–°ç»‘å®šæŒ‰é’®äº‹ä»¶
      location.reload();
    });
};

// æ¸…é™¤æœç´¢
document.getElementById('btn-clear').onclick = ()=>location.reload();

// æ–‡ä»¶ä¸Šä¼ 
document.getElementById('frm-upload').onsubmit = e=>{
  e.preventDefault();
  let fd = new FormData(e.target);
  fetch('/upload',{method:'POST', body:fd})
    .then(r=>r.json().then(j=>r.ok?listFiles():alert(j.error)))
    .catch(e=>alert(e));
};

// åˆ—å‡ºä¸Šä¼ æ–‡ä»¶
function listFiles(){
  fetch('/files').then(r=>r.json()).then(arr=>{
    let ul = document.getElementById('file-list');
    ul.innerHTML = '';
    arr.forEach(f=>{
      let li = document.createElement('li');
      li.className = 'list-group-item';
      let ext = f.name.split('.').pop().toLowerCase();
      let link = `<a href="${f.url}" target="_blank">${f.name}</a>`;
      if(['mp4','mp3','ogg'].includes(ext)){
        link += `<br><${ext} controls src="${f.url}"
          style="max-width:100%;margin-top:5px;"></${ext}>`;
      }
      li.innerHTML = link;
      ul.appendChild(li);
    });
  });
}
listFiles();
</script>

<!-- Modal HTML -->
<div class="modal fade" id="mdl" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="mdl-title">æ ‡é¢˜</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input id="mdl-input" class="form-control" placeholder="è¾“å…¥ç¬”è®°å">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary"
                data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button id="mdl-ok" class="btn btn-primary">ç¡®å®š</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}
'''

# --- æ¨¡æ¿ï¼šedit.html ---
EDIT_HTML = '''
{% extends 'base' %}
{% block title %}ç¼–è¾‘ï¼š{{ title }}{% endblock %}
{% block content %}
<h1 class="mb-4">ç¼–è¾‘ï¼š{{ title }}</h1>
<form method="post">
  <textarea name="content" class="form-control" rows="20">{{ content }}</textarea>
  <div class="mt-3">
    <button class="btn btn-primary">ä¿å­˜</button>
    <a class="btn btn-secondary" href="{{ url_for('view', title=title) }}">å–æ¶ˆ</a>
  </div>
</form>
{% endblock %}
'''

# --- æ¨¡æ¿ï¼šview.html ---
VIEW_HTML = '''
{% extends 'base' %}
{% block title %}æŸ¥çœ‹ï¼š{{ title }}{% endblock %}
{% block head %}
<link rel="stylesheet"
 href="https://cdn.jsdelivr.net/npm/katex@0.16.3/dist/katex.min.css">
<link rel="stylesheet"
 href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1>æŸ¥çœ‹ï¼š{{ title }}</h1>
  <div>
    <a class="btn btn-warning" href="{{ url_for('edit', title=title) }}">ç¼–è¾‘</a>
    {% if mode=='render' %}
      <a class="btn btn-secondary"
         href="{{ url_for('view', title=title, mode='raw') }}">
         åŸæ–‡</a>
    {% else %}
      <a class="btn btn-secondary"
         href="{{ url_for('view', title=title, mode='render') }}">
         æ¸²æŸ“</a>
    {% endif %}
    <a class="btn btn-link" href="{{ url_for('management') }}">ç®¡ç†</a>
  </div>
</div>
{% if mode=='raw' %}
  <pre class="border p-3">{{ content }}</pre>
{% else %}
  <div id="md" class="border p-4 rounded"></div>
{% endif %}
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it-katex@3.0.1/dist/markdown-it-katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it-highlightjs@3.3.0/dist/markdown-it-highlightjs.min.js"></script>
<script>
const md = window.markdownit({html:true,linkify:true,typographer:true})
            .use(window.markdownitKatex)
            .use(window.markdownitHighlightjs);
const content = {{ content|tojson }};
document.getElementById('md').innerHTML = md.render(content);
</script>
{% endblock %}
'''

# æ³¨å†Œ base æ¨¡æ¿ä¾› extends ä½¿ç”¨
app.jinja_loader.mapping = {
    'base': BASE_HTML
}


# --- å·¥å…·å‡½æ•°ï¼šå®‰å…¨ç¬”è®°è·¯å¾„ & åˆ—è¡¨ & LCS ---
def note_path(title):
    fn = secure_filename(title) or 'untitled'
    return os.path.join(NOTE_DIR, f"{fn}.md")

def list_notes():
    items = []
    for fn in os.listdir(NOTE_DIR):
        if fn.lower().endswith('.md'):
            t = fn[:-3]
            with open(os.path.join(NOTE_DIR, fn), encoding='utf-8') as f:
                c = f.read()
            items.append({'title': t, 'content': c})
    items.sort(key=lambda x: os.path.getmtime(note_path(x['title'])), reverse=True)
    return items

def lcs(a, b):
    la, lb = len(a), len(b)
    dp = [[0]*(lb+1) for _ in range(la+1)]
    for i in range(la):
        for j in range(lb):
            if a[i]==b[j]:
                dp[i+1][j+1] = dp[i][j]+1
            else:
                dp[i+1][j+1] = max(dp[i][j+1], dp[i+1][j])
    return dp[la][lb]


# --- è·¯ç”±ï¼šé¦–é¡µé‡å®šå‘ ---
@app.route('/')
def index():
    return redirect(url_for('management'))

# --- è·¯ç”±ï¼šç®¡ç†é¡µ ---
@app.route('/management')
def management():
    notes = list_notes()
    return render_template_string(MGMT_HTML, notes=notes)

# --- è·¯ç”±ï¼šæ–°å»º/é‡å‘½å/åˆ é™¤ï¼ˆAJAXï¼‰ ---
@app.route('/note/<action>', methods=['POST'])
def note_action(action):
    data = request.get_json(force=True)
    try:
        if action == 'new':
            title = data.get('title','').strip()
            if not title: raise ValueError('æ ‡é¢˜ä¸èƒ½ä¸ºç©º')
            p = note_path(title)
            if os.path.exists(p): raise FileExistsError('å·²å­˜åœ¨åŒåç¬”è®°')
            open(p,'w',encoding='utf-8').close()

        elif action == 'rename':
            old = data.get('old','').strip()
            new = data.get('new','').strip()
            if not old or not new: raise ValueError('åç§°ä¸èƒ½ä¸ºç©º')
            oldp, newp = note_path(old), note_path(new)
            if not os.path.exists(oldp): raise FileNotFoundError('æºæ–‡ä»¶ä¸å­˜åœ¨')
            if os.path.exists(newp): raise FileExistsError('ç›®æ ‡ç¬”è®°å·²å­˜åœ¨')
            os.rename(oldp, newp)

        elif action == 'delete':
            title = data.get('title','').strip()
            p = note_path(title)
            if os.path.exists(p):
                os.remove(p)

        else:
            raise ValueError('æœªçŸ¥æ“ä½œ')

        return jsonify(ok=True)
    except Exception as e:
        return jsonify(ok=False, error=str(e)), 400

# --- è·¯ç”±ï¼šç¼–è¾‘ç¬”è®° ---
@app.route('/edit/<title>', methods=['GET','POST'])
def edit(title):
    p = note_path(title)
    if request.method == 'POST':
        content = request.form.get('content','')
        with open(p,'w',encoding='utf-8') as f:
            f.write(content)
        return redirect(url_for('view', title=title))

    if not os.path.exists(p):
        abort(404, 'ç¬”è®°ä¸å­˜åœ¨')
    with open(p, encoding='utf-8') as f:
        content = f.read()
    return render_template_string(EDIT_HTML, title=title, content=content)

# --- è·¯ç”±ï¼šæŸ¥çœ‹ç¬”è®° ---
@app.route('/view/<title>')
def view(title):
    mode = request.args.get('mode','render')
    p = note_path(title)
    if not os.path.exists(p):
        abort(404, 'ç¬”è®°ä¸å­˜åœ¨')
    with open(p, encoding='utf-8') as f:
        content = f.read()
    return render_template_string(VIEW_HTML,
                                  title=title,
                                  content=content,
                                  mode=mode)

# --- è·¯ç”±ï¼šæœç´¢ï¼ˆä¼˜å…ˆæ ‡é¢˜åŒ¹é…ï¼‰ ---
@app.route('/search')
def search():
    q = request.args.get('q','').lower()
    results = []
    for note in list_notes():
        t = note['title'].lower()
        c = note['content'].lower()
        if q in t or q in c:
            score = (lcs(q, t) * 3 if q in t else 0) + lcs(q, c)
            results.append({
                'title': note['title'],
                'score': score
            })
    results.sort(key=lambda x: x['score'], reverse=True)
    return jsonify(results)

# --- è·¯ç”±ï¼šæ–‡ä»¶ä¸Šä¼  & åˆ—è¡¨ & è®¿é—® ---
@app.route('/upload', methods=['POST'])
def upload():
    f = request.files.get('file')
    if not f:
        return jsonify(ok=False, error='æœªé€‰æ‹©æ–‡ä»¶'), 400
    fn  = secure_filename(f.filename)
    ext = fn.rsplit('.',1)[-1].lower()
    if ext not in ALLOWED_EXT:
        return jsonify(ok=False, error='ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹'), 400
    dst = os.path.join(UPLOAD_DIR, fn)
    f.save(dst)
    return jsonify(ok=True, url=url_for('uploaded_file', filename=fn))

@app.route('/files')
def files():
    arr = []
    for fn in os.listdir(UPLOAD_DIR):
        url = url_for('uploaded_file', filename=fn)
        arr.append({'name': fn, 'url': url})
    return jsonify(arr)

@app.route('/uploads/<filename>')
def uploaded_file(filename):
    return send_from_directory(UPLOAD_DIR, filename)


if __name__ == '__main__':
    app.run(debug=True)
